<div class="container container-wide">
  <div class="header-section">
    <h1>Community Meetings</h1>
    <p>Connect with others in safe, supportive spaces.</p>
  </div>

  <mat-tab-group mat-stretch-tabs="false" mat-align-tabs="start" animationDuration="0ms">
    <!-- Meeting Rooms Tab -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">meeting_room</mat-icon>
        Meeting Rooms
      </ng-template>

      <div class="rooms-layout">
        <!-- Room List (Left Panel) -->
        <div class="room-list glass-card" [class.hidden-mobile]="selectedMeetingRoom">
          <div class="panel-header">
            <h3>Available Rooms</h3>
          </div>
          <mat-nav-list class="room-nav">
            @for (room of meetingRooms; track room.id) {
            <a mat-list-item (click)="selectRoom(room)" [class.active-room]="selectedMeetingRoom?.id === room.id">
              <mat-icon matListItemIcon>chat_bubble_outline</mat-icon>
              <div matListItemTitle>{{ room.name }}</div>
              <div matListItemLine class="room-desc">{{ room.description }}</div>
              <mat-icon matListItemMeta>chevron_right</mat-icon>
            </a>
            }
          </mat-nav-list>
        </div>

        <!-- Active Room (Right Panel) -->
        <div class="active-room glass-card" *ngIf="selectedMeetingRoom">
          <!-- Room Header -->
          <div class="room-header">
            <button mat-icon-button class="back-btn mobile-only" (click)="selectedMeetingRoom = null; stopPolling()">
              <mat-icon>arrow_back</mat-icon>
            </button>
            <div class="room-info">
              <h2>{{ selectedMeetingRoom.name }}</h2>
              <span class="status-badge live">
                <span class="pulse"></span> Live
              </span>
            </div>
            <div class="room-actions">
              <button mat-stroked-button color="primary" (click)="joinQueue()" [disabled]="isInQueue">
                <mat-icon>handshake</mat-icon> Request Share
              </button>

              <button mat-flat-button color="primary" *ngIf="!isInCall()" [matMenuTriggerFor]="callMenu">
                <mat-icon>videocam</mat-icon> Join Call
              </button>
              <mat-menu #callMenu="matMenu">
                <button mat-menu-item (click)="joinVoiceCall()">Audio Only</button>
                <button mat-menu-item (click)="joinVideoCall()">Video Call</button>
              </mat-menu>

              <button mat-flat-button color="warn" *ngIf="isInCall()" (click)="leaveCall()">
                <mat-icon>call_end</mat-icon> Leave
              </button>
            </div>
          </div>

          <!-- Video Area -->
          <div class="video-area" *ngIf="isInVideoCall && openVidu.session">
            <app-video-call [publisher]="openVidu.publisher" [subscribers]="openVidu.subscribers"></app-video-call>
          </div>

          <!-- Active Participants Info -->
          <div class="participants-bar" *ngIf="activeVoiceParticipants.length > 0 && !isInVideoCall">
            <span class="label">Audio Participants:</span>
            <div class="avatars">
              @for (participant of activeVoiceParticipants; track participant) {
              <div class="avatar" [matTooltip]="participant">{{ participant.charAt(0).toUpperCase() }}</div>
              }
            </div>
          </div>

          <!-- Chat Area -->
          <div class="chat-container">
            <div class="messages-list">
              @for (message of messages; track message.id) {
              <div class="message-bubble" [class.mine]="message.author === messageAuthor">
                <div class="message-meta" *ngIf="message.author !== messageAuthor">
                  <span class="author-name">{{ message.author }}</span>
                </div>
                <div class="bubble-content">
                  {{ message.content }}
                </div>
                <div class="message-time">{{ message.timestamp | date:'shortTime' }}</div>
              </div>
              }
            </div>

            <div class="input-area">
              <input type="text" placeholder="Type a message..." [(ngModel)]="newMessageContent"
                (keyup.enter)="sendMessage()">
              <button mat-icon-button color="primary" (click)="sendMessage()" [disabled]="!newMessageContent.trim()">
                <mat-icon>send</mat-icon>
              </button>
            </div>
          </div>

          <!-- Queue Overlay/Sidebar -->
          <div class="queue-panel" *ngIf="sharingQueue.length > 0">
            <div class="queue-header">Sharing Queue</div>
            <mat-list dense>
              @for (entry of sharingQueue; track entry.id) {
              <mat-list-item>
                <mat-icon matListItemIcon>person</mat-icon>
                <div matListItemTitle>{{ entry.author }}</div>
                <button mat-icon-button matListItemMeta *ngIf="entry.author === messageAuthor" (click)="leaveQueue()"
                  color="warn">
                  <mat-icon>close</mat-icon>
                </button>
              </mat-list-item>
              }
            </mat-list>
          </div>

        </div>

        <!-- Select Room Placeholder -->
        <div class="active-room glass-card placeholder" *ngIf="!selectedMeetingRoom">
          <mat-icon>groups</mat-icon>
          <h3>Select a room to join the conversation</h3>
        </div>
      </div>
    </mat-tab>

    <!-- Online Meetings Tab (Iframe) -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">public</mat-icon>
        Global Directory
      </ng-template>
      <div class="iframe-container glass-card">
        <iframe src="https://aa-intergroup.org/meetings/" class="embedded-meetings"></iframe>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>